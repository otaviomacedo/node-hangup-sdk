let totalCount = Number(process.env.BREAKER ?? '1') || 1;
const initialCount = totalCount;

let i = 0;

module.exports = function() {
  i++;
  totalCount--;
  const stopping = totalCount <= 0;

  const stack = new Error().stack.split('\n').slice(2);

  process.stderr.write([
    '-----------------------------------------------------------',
    `BREAKPOINT ${i}. Stopping: ${stopping}`,
    ...stack,
    '-----------------------------------------------------------',
  ].join('\n') + '\n');
  if (stopping) {
    throw new Error(`Stopped by the breaker after ${initialCount} breaks`);
  }
};